# AWS WAFv2 Advanced Fail2ban Integration

AWS WAFv2ã‚’ä½¿ç”¨ã—ãŸé«˜åº¦ãªfail2banæ©Ÿèƒ½ã¨IPç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

## æ¦‚è¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€AWS WAFv2ã‚’ä½¿ç”¨ã—ã¦fail2banã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã€CloudFront + S3ã§æ§‹æˆã•ã‚ŒãŸWebã‚µã‚¤ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã®Terraformã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚WhiteList/BlackListæ©Ÿèƒ½ã€æ®µéšçš„ãªç›£è¦–ãƒ»ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ã€è©³ç´°ãªã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
aws-wafv2-fail2ban/
â”œâ”€â”€ terraform/           # Terraformãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ *.tf            # Terraformè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ lambda/         # Lambdaé–¢æ•°
â”‚   â””â”€â”€ terraform.tfvars.example
â”œâ”€â”€ scripts/            # é‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”œâ”€â”€ test.sh        # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â””â”€â”€ deploy.sh      # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ Makefile           # Makeæ“ä½œå®šç¾©
â””â”€â”€ README.md          # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ä¸»è¦æ©Ÿèƒ½

### ğŸ›¡ï¸ 4æ®µéšã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

1. **WhiteList Rule (å„ªå…ˆåº¦1)** - æ°¸ä¹…ã«BANã—ãªã„
   - ä¿¡é ¼ã§ãã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ°¸ç¶šçš„ã«è¨±å¯
   - æœ€é«˜å„ªå…ˆåº¦ã§ä»–ã®ãƒ«ãƒ¼ãƒ«ã‚’ãƒã‚¤ãƒ‘ã‚¹

2. **BlackList Rule (å„ªå…ˆåº¦2)** - ãšã£ã¨BANã™ã‚‹  
   - æ‚ªæ„ã®ã‚ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ°¸ç¶šçš„ã«ãƒ–ãƒ­ãƒƒã‚¯
   - æ‰‹å‹•ç®¡ç†ã«ã‚ˆã‚‹ç¢ºå®Ÿãªé®æ–­

3. **Count Rule (å„ªå…ˆåº¦3)** - é–¾å€¤ç›£è¦–ç”¨
   - è¨­å®šã—ãŸé–¾å€¤ã§ã‚«ã‚¦ãƒ³ãƒˆã®ã¿å®Ÿè¡Œ
   - ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿã®ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦æ©Ÿèƒ½

4. **Block Rule (å„ªå…ˆåº¦4)** - å®Ÿéš›ã®ãƒ–ãƒ­ãƒƒã‚¯ç”¨
   - é–¾å€¤è¶…éæ™‚ã«è‡ªå‹•çš„ã«IPã‚’ãƒ–ãƒ­ãƒƒã‚¯
   - ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•è§£é™¤

### ğŸ“Š è©³ç´°ãªç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½

- **Count Threshold Alert**: Countå€¤ãŒé–¾å€¤ã‚’è¶…ãˆãŸéš›ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
- **IP Blocked Alert**: IPãŒãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚ŒãŸéš›ã®ã‚¢ãƒ©ãƒ¼ãƒˆ  
- **IP Unblocked Alert**: IPãŒãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰è§£é™¤ã•ã‚ŒãŸéš›ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
- **SNSé€šçŸ¥**: Emailé…ä¿¡
- **Slacké€šçŸ¥**: æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®é€šçŸ¥

### ğŸ¯ å¯¾è±¡ãƒ‘ã‚¹è¨­å®š

- `/website`é…ä¸‹ã®å…¨ã¦ã®URIï¼ˆã‚µãƒ–ãƒ‘ã‚¹å«ã‚€ï¼‰ã«å¯¾å¿œ
- ä¾‹: `/website/`, `/website/download`, `/website/api/v1` ãªã©

## ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. å‰ææ¡ä»¶

- Terraform >= 1.0
- AWS CLIè¨­å®šæ¸ˆã¿ï¼ˆAWS SSOå¯¾å¿œï¼‰
- é©åˆ‡ãªIAMæ¨©é™
- æ—¢å­˜ã®CloudFront Distribution

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
# terraform.tfvarsã‚’ç·¨é›†ã—ã¦ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®š
```

## ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

### Terraform

```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
# terraform.tfvarsã‚’ç·¨é›†
make init
make plan
make apply
```

### CloudFormation

```bash
cd cloudformation
# parameters.jsonã‚’ç·¨é›†
./deploy.sh
```

### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ãŸæ“ä½œ

```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./scripts/test.sh

# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆTerraformï¼‰
./scripts/deploy.sh
```

## è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | èª¬æ˜ |
|-----------|-------------|------|
| `count_threshold` | 50 | Counté–¾å€¤ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿï¼‰ |
| `rate_limit_requests` | 100 | Blocké–¾å€¤ï¼ˆãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œï¼‰ |
| `block_duration_seconds` | 3600 | ãƒ–ãƒ­ãƒƒã‚¯ç¶™ç¶šæ™‚é–“ï¼ˆç§’ï¼‰ |
| `target_path` | "/website" | ç›£è¦–å¯¾è±¡ã®ãƒ‘ã‚¹ |
| `whitelist_ips` | [] | ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆIPä¸€è¦§ |
| `blacklist_ips` | [] | ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆIPä¸€è¦§ |
| `notification_email` | "" | SNSé€šçŸ¥ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| `slack_webhook_url` | "" | Slack Webhook URL |
| `slack_channel` | "aws_system_notify" | Slackãƒãƒ£ãƒ³ãƒãƒ«å |
| `teams_webhook_url` | "" | Microsoft Teams Webhook URL |

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Internet â†’ CloudFront â†’ WAFv2 â†’ S3
                â†“
    [WhiteList] â†’ Allow (æ°¸ä¹…è¨±å¯)
         â†“
    [BlackList] â†’ Block (æ°¸ä¹…æ‹’å¦)  
         â†“
    [Count Rule] â†’ Count (é–¾å€¤ç›£è¦–)
         â†“
    [Block Rule] â†’ Block (ä¸€æ™‚æ‹’å¦)
         â†“
    CloudWatch Logs & Alarms
         â†“
    SNS â†’ Email & Slacké€šçŸ¥
```

## ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### CloudWatch Logs
- ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—: `/aws/wafv2/fail2ban`
- ä¿æŒæœŸé–“: 30æ—¥
- æ©Ÿå¯†æƒ…å ±é™¤å¤–æ¸ˆã¿

### CloudWatch Alarms

1. **Count Threshold Alarm** (`waf-count-threshold-exceeded`)
2. **IP Blocked Alarm** (`waf-ip-blocked-alert`)
3. **IP Unblocked Alarm** (`waf-ip-unblocked-alert`)

### é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- **SNS Topic**: `waf-fail2ban-notifications`
- **Emailé€šçŸ¥**: è¨­å®šã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é…ä¿¡
- **Slacké€šçŸ¥**: æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã«é…ä¿¡
- **Teamsé€šçŸ¥**: æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã«é…ä¿¡

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …

âš ï¸ **é‡è¦**: ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯AWS Managed Rulesã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã¾ã™
- è„†å¼±æ€§ãƒªã‚¹ã‚¯ãŒé«˜ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- æœ¬ç•ªç’°å¢ƒã§ã®ä½¿ç”¨ã¯æ…é‡ã«æ¤œè¨ã—ã¦ãã ã•ã„
- å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **CloudFrontã¨ã®é–¢é€£ä»˜ã‘ã‚¨ãƒ©ãƒ¼**
   - Web ACLã®ã‚¹ã‚³ãƒ¼ãƒ—ãŒ`CLOUDFRONT`ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
   - us-east-1ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®ä½œæˆã‚’ç¢ºèª

2. **é€šçŸ¥ãŒå±Šã‹ãªã„**
   - SNS Topic Policyã®è¨­å®šã‚’ç¢ºèª
   - Slack Webhook URLã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª

3. **ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹**
   - `./scripts/test.sh`ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª
   - å¿…è¦ãªä¾å­˜é–¢ä¿‚ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License

## è²¢çŒ®

ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ã‚¤ã‚·ãƒ¥ãƒ¼ã®å ±å‘Šã‚’æ­“è¿ã—ã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹å•é¡Œã¯ã€ç›´æ¥ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼ã«ã”é€£çµ¡ãã ã•ã„ã€‚

## æ›´æ–°å±¥æ­´

- v3.0.0: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆæ•´ç†ã€ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ ã€Makefileè¿½åŠ 
- v2.0.0: WhiteList/BlackListæ©Ÿèƒ½ã€æ®µéšçš„ç›£è¦–æ©Ÿèƒ½ã€è©³ç´°ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ 
- v1.0.0: åŸºæœ¬çš„ãªfail2banæ©Ÿèƒ½ã‚’å®Ÿè£…